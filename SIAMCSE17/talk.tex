\documentclass[hide notes,intlimits,usenames,dvipsnames]{beamer}

\mode<presentation>
{
  \usetheme{Singapore}
  \usefonttheme{professionalfonts}
  \setbeamertemplate{blocks}[rounded][shadow=true]
  \setbeamercovered{transparent}
  \setbeamertemplate{footline}[frame number]
}

% load packages
\usepackage[english]{babel}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage[multidot]{grffile}
\usepackage{verbatim,empheq}

\usepackage{tikz}
\usetikzlibrary{shapes,arrows,shadows}
\usetikzlibrary{decorations.pathreplacing}

\usepackage{animate}
\usepackage{amsmath,verbatim}

% see http://tex.stackexchange.com/questions/86188/labelling-with-arrows-in-an-automated-way

\newif\ifclipme\clipmetrue
\tikzset{labelstyle/.style={LabelStyle/.append style={#1}},linestyle/.style={LineStyle/.append style={#1}}}
\tikzset{LabelStyle/.initial={},LineStyle/.initial={}}

\newcommand{\mathWithDescription}[4][]{{%
    \tikzset{#1}%
    \tikz[baseline]{
        \node[draw=red,rounded corners,anchor=base] (m#4) {$\displaystyle#2$};
        \ifclipme\begin{pgfinterruptboundingbox}\fi
            \node[above of=m#4,font=\strut, LabelStyle] (l#4) {#3};
            \draw[-,red, LineStyle] (l#4) to (m#4);
        \ifclipme\end{pgfinterruptboundingbox}\fi
    }%
}}

\newcommand{\mathWithDescriptionStarred}[3][]{{%
    \clipmefalse%
    \mathWithDescription[#1]{#2}{#3}{\themathLabelNode}%
}}

\newcounter{mathLabelNode}

\newcommand{\mathLabelBox}[3][]{%
   \stepcounter{mathLabelNode}%
   \mathWithDescription[#1]{#2}{#3}{\themathLabelNode}%
   \vphantom{\mathWithDescriptionStarred[#1]{#2}{#3}{\themathLabelNode}}%
}

\definecolor{dark red}{HTML}{E41A1C}
\definecolor{dark green}{HTML}{4DAF4A}
\definecolor{dark violet}{HTML}{984EA3}
\definecolor{dark blue}{HTML}{084594}
\definecolor{dark orange}{HTML}{FF7F00}
\definecolor{light blue}{HTML}{377EB8}
\definecolor{light red}{HTML}{FB9A99}
\definecolor{light violet}{HTML}{CAB2D6}

\newcommand{\CC}{\mathbb{C}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}

\newcommand{\Kcal}{\mathcal{K}}
\newcommand{\Xcal}{\mathcal{X}}

\newcommand{\bF}{\mathbf{F}}
\newcommand{\bQ}{\mathbf{Q}}
\newcommand{\bU}{\mathbf{U}}
\newcommand{\bX}{\mathbf{X}}

\newcommand{\bq}{\mathbf{q}}
\newcommand{\bu}{\mathbf{u}}
\newcommand{\bv}{\mathbf{v}}
\newcommand{\bx}{\mathbf{x}}

\newcommand{\Div}{\nabla\cdot}
\newcommand{\eps}{\epsilon}
\newcommand{\grad}{\nabla}
\newcommand{\lap}{\triangle}
\renewcommand{\bar}{\overline}

\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}


\newenvironment{transbox}[1][]{%
\begin{tikzpicture}
\node[drop shadow,rounded corners,text width=\textwidth,fill=white, fill opacity=#1,text opacity=1] \bgroup
}{
\egroup;\end{tikzpicture}}


\title[Implicit time-stepping for ice sheets]{Implicit time-stepping for ice sheets}

\author[Bueler]{Ed Bueler}

\institute[UAF]{
  \scriptsize Dept of Mathematics and Statistics and Geophysical Institute \\

  University of Alaska Fairbanks
}

\titlegraphic{\includegraphics[width=\textwidth]{andycoast.png}}

\beamertemplatenavigationsymbolsempty   % remove faint and silly navigation symbols at bottom
\renewcommand{\insertnavigation}[1]{}   % remove section headings from top of each slide

\setbeamerfont{date}{size=\scriptsize}
\date{}

%\AtBeginSection[]
%{
%  \begin{frame}<beamer>
%    \frametitle{Outline}
%    %\tableofcontents[currentsection,hideallsubsections]
%    \tableofcontents[currentsection]
%  \end{frame}
%}


\begin{document}

%\graphicspath{{figs/}{../commonfigs/}}
\graphicspath{{../commonfigs/}}

\begin{frame}
\vspace{10mm}
  \titlepage
  \begin{center}
  \tiny SIAM CSE \quad 2 March, 2017 \hfill  supported by NASA grant \# NNX13AM16G
  \end{center}
\end{frame}

  \begin{frame}
    \frametitle{Outline}
    \tableofcontents
  \end{frame}

\section{problem, goals, and models}

\begin{frame}{ice sheet flows and their boundaries}
\begin{columns}
\begin{column}{0.45\textwidth}
\begin{itemize}
\item<1> nearly-fractal free boundaries
    \begin{itemize}
    \scriptsize
    \item[$\circ$] location determined by flow, topography, and atmosphere/ocean inputs
    \normalsize
    \end{itemize}
\item<2> large fraction of the boundary: grounded margins
\item<3> surface slope is discontinuous at grounded margins
\end{itemize}
\end{column}
\begin{column}{0.55\textwidth}
\only<1>{\includegraphics[height=0.8\textheight]{ice-mask-900m.png} \\ {\tiny \hfill PISM mask, by A.~Aschwanden}}
\includegraphics<2>[height=0.85\textheight]{jako-crop-mask-900m.png}
\only<3>{\includegraphics[width=1.05\textwidth]{truffertaku2016.jpg} \\ {\tiny \hfill Taku Glacier, Alaska, by M.~Truffer}}
\end{column}
\end{columns}
\end{frame}


\begin{frame}{computational goal: long-time, high-res runs}

\begin{itemize}
\item my goal (I am not the only one?!):
\begin{quote}
routinely simulate ice sheets on their natural time scales (ice age cycles \alert{$\gtrsim 10^5$ years}) at resolutions where bedrock bumps, outlet glaciers, ice streams, and grounding lines are resolved (\alert{$\lesssim 500$ m})
\end{quote}
\item some concerns:
    \begin{enumerate}
    \item stress-balance solves expensive
        \begin{itemize}
        \item[$\circ$] if time steps are short then momentum conservation becomes a lot of work
        \item[$\circ$] \dots energy conservation (for temperature and basal melt) too
        \end{itemize}
    \item evolution of ice thickness $H(t,x,y)$ is diffusive
        \begin{itemize}
        \item[$\circ$] because ice flows downhill
        \end{itemize}
    \item ice margins are low-regularity
        \begin{itemize}
        \item[$\circ$] for two reasons: (\emph{i}) constraint $H\ge 0$ and (\emph{ii}) degeneracy: stresses $\to 0$ at margins
        \end{itemize}
    \item bedrock is steep
    \end{enumerate}

\medskip
\scriptsize
\item PISM (Parallel Ice Sheet Model) not there yet \dots either long-time \emph{OR} high-res
\end{itemize}
\end{frame}


\begin{frame}{ice sheet models}

\begin{itemize}
\item covering at least two models:
    \begin{itemize}
    \item[$\circ$] shallow, possibly-hybrid, thickness-based \hfill {\scriptsize\color{Gray} $H,\, \mathbf{u}=(u,v)$}
        \begin{align*}
        H_t + \Div (-D \grad H + \bar{\mathbf{u}} H) &= m(x,t) && \text{mass conservation} \\
        \mathcal{L}(\mathbf{u},H) &= 0      && \text{shallow stress balance}
        \end{align*}
    \item[$\circ$] Stokes, surface-elevation-based \hfill {\scriptsize\color{Gray} $s,\, \mathbf{u}=(u,v,w)$}
        \begin{align*}
        s_t + \mathbf{u}\big|_s \cdot (s_x,s_y,-1) &= m(x,t) && \text{surface kinematical} \\
        \Div \mathbf{u} &= 0            && \text{incompressibility} \\
        \mathcal{L}(\mathbf{u},s) &= 0  && \text{Stokes stress balance}
        \end{align*}
    \end{itemize}
\item (notation: $H$ thickness, $s$ surface elevation, $\mathbf{u}$ velocity)
\item assumptions:
    \begin{itemize}
    \item[$\circ$] conservation of energy ignored for simplicity
    \item[$\circ$] fixed computational domain $\Omega$ where $b,m$ given
        \begin{itemize}
        \item $\Omega$ is only partly covered by ice
        \end{itemize}
    \item[$\circ$] Eulerian, fixed grid (structured or not)
    \end{itemize}
\end{itemize}
\end{frame}


\section{semi-discretizations}

\begin{frame}{semi-discretize in space?}

\begin{itemize}
\item discretize in space first
    \begin{itemize}
    \item[$\circ$] method of lines (MOL)
    \item[$\circ$] \emph{can you hand the resulting system to an ODE solver?}
    \end{itemize}
\item well-known: MOL for slow fluids is a DAE problem
\begin{align*}
\dot H &= f(H,\mathbf{u},t) && \text{mass conservation} \\
     0 &= g(H,\mathbf{u})   && \text{momentum conservation}
\end{align*}
\vspace{-5mm}
    \begin{itemize}
    \item[$\circ$] \emph{is implicit time-stepping required for DAEs anyway?}
    \end{itemize}
\item velocity variables exist at positive-thickness locations $i$:
    $$\mathbf{u}_i \text{ exists } \quad \Longleftarrow \quad H_i > 0 \iff h_i > b_i$$
\item some ODE solvers can handle \emph{events} like these:
    \begin{itemize}
    \item[$\circ$] ice disappears during time step:  $H_i(t)>0 \to H_i(t+\Delta t)=0$
    \item[$\circ$] ice appears during time step:  $H_i(t)=0 \to H_i(t+\Delta t)>0$
    \end{itemize}
\end{itemize}
\end{frame}


\begin{frame}{MOL$+$events cannot scale}

\begin{center}
\input{tikz/molevents.tex}
\end{center}

\vspace{-6mm}
\begin{itemize}
\item at each event the ice velocity dimension changes
\item ice sheet margins nearly fractal, so \emph{a lot} of events to handle
\end{itemize}
\end{frame}


\begin{frame}{semi-discretize in time}

\begin{itemize}
\item semi-discretize in time \emph{for understanding}, if nothing else
\item consider a single backward Euler time-step
    \begin{itemize}
    \item[$\circ$] better time-stepping later
    \end{itemize}
\item hybrid equations become:
        \begin{align*}
        H - H_{\mathrm{old}} + \Delta t\, \Div (-D \grad H + \mathbf{u} H) &= \Delta t\, m \\
        \mathcal{L}(\mathbf{u},H) &= 0
        \end{align*}
\end{itemize}
\end{frame}


\begin{frame}{single time-step problem for mass conservation}

\small

\begin{itemize}
\item supposing $\mathbf{u}$ given, to solve:
        \begin{equation}
        H - H_{\mathrm{old}} + \Delta t\, \Div \mathbf{q} = \Delta t\, m \tag{$\ast$}
        \end{equation}
   \begin{itemize}

\vspace{-5mm}
   \item[$\circ$] where $\mathbf{q} = -D \grad H + \mathbf{u} H$
   \item[$\circ$] note: $D=D(H,|\grad s|) \to 0$ at margins
   \end{itemize}
\item solve this system for \,$H,\mathbf{u}$\, \emph{but} subject to $H \ge 0$
\item ($\ast$) can be made rigorous two ways:
    \begin{itemize}
    \item[$\circ$] variational inequality (VI)
    $$\int_\Omega (H - H_{\mathrm{old}} -\Delta t\, m) (\eta - H) - \Delta t\, \mathbf{q} \cdot \grad(\eta - H) \ge 0, \quad \forall \eta \ge 0$$
    \item[$\circ$] nonlinear complementarity problem (NCP)
\begin{align*}
F(H)   &= H - H_{\mathrm{old}} -\Delta t\, m + \Delta t\,\Div \mathbf{q} \ge 0 \\
H      &\ge 0 \\
H F(H) &= 0
\end{align*}
    \end{itemize}
\end{itemize}
\end{frame}


\section{solving the equations for one time step}

\begin{frame}{solving the equations}
\begin{itemize}
\item FVE  FIXME: stencil cartoon
\item Newton + Krylov + preconditioning
\end{itemize}
\end{frame}


\begin{frame}{margin advance experiment: Newton iterations}
\begin{itemize}
\item 10 year time step results FIXME
\item Newton iteration sees Jacobian in inactive variables only (PETSc: \texttt{-snes\_type vinewtonrsls})
\item<2> number of Newton iterations is proportional to margin advance (975 m) divided by the number grid spaces
\end{itemize}

\begin{center}
\includegraphics<1>[width=0.6\textwidth]{newtoniters.pdf}
\includegraphics<2>[width=0.6\textwidth]{newtonitersFIT.pdf}
\end{center}
\end{frame}


\begin{frame}[fragile]
\frametitle{margin advance experiment: preconditioners}
\begin{itemize}
\item method:

\small
\centerline{\texttt{-snes\_type vinewtonrsls -ksp\_type gmres -pc\_type PC}}
\normalsize
\item preconditioner comparison:
\small
    \begin{itemize}
    \item<1>[$\circ$] Krylov iterations per Newton step
    \item<2>[$\circ$] wall clock time per d.o.f.~per Newton step
    \end{itemize}
\end{itemize}

\begin{center}
\includegraphics<1>[width=0.6\textwidth]{pcksppernewton.pdf}
\includegraphics<2>[width=0.6\textwidth]{pctimeperdof.pdf}
\end{center}
\end{frame}


\begin{frame}{margin advance experiment:  weak scaling}
\begin{itemize}
\item FIXME
\item 
\end{itemize}
\end{frame}


\section{some early results}

\begin{frame}{50ka run with sliding}
\begin{columns}
\begin{column}{0.4\textwidth}
\begin{itemize}
\item FIXME hybrid method with $V$
\item steady climate with elevation-dependent accumulation/ablation
\item initial state (upper) is just snow piled up; shows ela
\item FIXME ARKIMEX + $3$ or more NCP solves at each time step
\end{itemize}
\end{column}
\begin{column}{0.6\textwidth}
\includegraphics[width=\textwidth]{startsheet.png}

\includegraphics[width=\textwidth]{endsheet.png}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{50ka run with sliding: performance}
\begin{columns}
\begin{column}{0.4\textwidth}
\begin{itemize}
\item FIXME
\end{itemize}
\end{column}
\begin{column}{0.6\textwidth}
FIXME  show $\Delta t$ vs dtD and dtCFL, under grid refinement
\end{column}
\end{columns}
\end{frame}


\begin{frame}{Greenland steady}
\begin{itemize}
\item show map-plane figures
\item show: convergence depends on roughness
\end{itemize}
\end{frame}


\begin{frame}{FIXME}
\begin{itemize}
\item FIXME recommended ``new PISM'' run
\item 
\end{itemize}
\end{frame}


\end{document}
